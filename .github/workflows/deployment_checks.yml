name: Deployment Checks

on:
  deployment_status:

jobs:
  # Vercel deployment status events are missing the `ref` metadata, they incorrectly set it
  # to the sha. This breaks github caching. Here we are trying to get the ref for use in
  # subsequent jobs.
  # https://github.com/actions/cache/issues/319
  get_ref:
    # We only want to run on success, otherwise it might be "pending", or "failure".
    if: ${{ github.event.deployment_status.state == 'success' }}
    name: deployment placeholder workflow
    runs-on: ubuntu-latest
    outputs:
      calculated_ref: ${{ steps.ref_from_sha.outputs.pr_head_ref }}

    steps:
      - uses: actions/checkout@v2

      # Set up Node without caching, because we don't have the ref yet.
      - name: Use Node.js 14
        uses: actions/setup-node@v2
        with:
          node-version: 14.x

      - run: npm ci

      # Get the ref from the SHA
      - uses: ./.github/actions/ref_from_sha
        name: Get PR Ref from SHA
        id: ref_from_sha
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: print ref from sha
        run: echo "${{ steps.ref_from_sha.outputs.pr_head_ref }}"

  # Run Pa11y.
  run_pa11y:
    # Only want to run on success, otherwise it might be "pending", or "failure".
    if: ${{ github.event.deployment_status.state == 'success' }}
    # Only run after the job the calculates the ref.
    needs: get_ref
    name: Run Pa11y
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # Set up Node WITH caching because we have the `ref` now.
      - name: Use Node.js 14
        uses: actions/setup-node@v2
        with:
          node-version: 14.x
          cache: npm
        env:
          GITHUB_REF: ${{needs.get_ref.outputs.calculated_ref}}

      - run: npm ci

      - name: Log out URL
        run: echo "${{ github.event.deployment_status.target_url }}"

      # Run pa11y
      - name: Pa11y CI
        run: npm run pa11y
        env:
          BASE_URL: ${{ github.event.deployment_status.target_url }}
